{% extends "base.html" %}

{% block pagetitle %}Overall game stats{% endblock %}

{% block content %}

<h2>
	Overall game stats
	<div style="float: right;">
		{% include "season_chooser.html" %}
		{% include "chooser.html" with chooser=player_count_chooser %}
	</div>
</h2>

<hr>

<h3>Sips distribution ({{ sips_data.total_ys }} data points)</h3>

Approximate distribution:
<span style="white-space: pre;">{{ sips_data.dist_str }}</span>

<div id="sips_chart"></div>

<h3>Chugs distribution ({{ chugs_data.total_ys }} data points)</h3>

Exact distribution:
<span style="white-space: pre;">{{ chugs_data.dist_str }}</span>

<div id="chugs_chart"></div>

{% endblock %}

{% block scripts %}
{{ sips_data|json_script:"sips_data" }}
{{ chugs_data|json_script:"chugs_data" }}

<script>
	var charts = [{
		data: "sips_data",
		chart: "sips_chart",
		name: "Sips",
	}, {
		data: "chugs_data",
		chart: "chugs_chart",
		name: "Chugs",
	}];

	function normal_distribution(mu, sigma, x) {
		return 1 / (sigma * Math.sqrt(2 * Math.PI)) * Math.exp(-1/2 * Math.pow((x - mu) / sigma, 2));
	}

	for (var i = 0; i < charts.length; i++) {
		var data = JSON.parse(document.getElementById(charts[i].data).textContent);
		var chart_el = document.getElementById(charts[i].chart);

		if (data.xs.length === 0) {
			chart_el.textContent = 'No data';
			continue;
		}

		var options = {
			chart: {
				height: 500,
			},
			plotOptions: {
				bar: {
					columnWidth: "90%",
				},
			},
			dataLabels: {
				enabled: false,
			},
			stroke: {
				show: true,
				width: 2,
				colors: ["transparent"],
			},
			xaxis: {
				title: {
					text: charts[i].name + " for one player in one game",
				},
				categories: data.xs,
			},
			series: [{
				type: "bar",
				name: "Occurences",
				data: data.ys,
			}],
			yaxis: {
				title: {
					text: "Occurences",
				},
				decimalsInFloat: 0,
			},
			tooltip: {
				enabledOnSeries: [0],
				y: {
					formatter: (function(data) {
						return function(val, d) {
							return val + " (" + (val / data.total_ys * 100).toFixed(2) + " %,"
								+ " expected: " + (data.probs[d.dataPointIndex] * 100).toFixed(2) + " %"
								+ (data.probs_exact? "": " approx.") +")";
						};
					})(data),
				},
			},
		};

		if (charts[i].data === "sips_data" && data.probs.length !== 0) {
			var expected = [];
			for (var j = 0; j < data.probs.length; j++) {
				expected.push(data.probs[j] * data.total_ys);
			}
			options.series.push({
				type: "line",
				name: "Expected occurences",
				data: expected,
			});
		}

		var chart = new ApexCharts(chart_el, options);
		chart.render();
	}
</script>
{% endblock %}
