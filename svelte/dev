#!/bin/sh
set -euo pipefail

rm -rf static/svelte
mkdir -p templates

yarn run dev &

{
	echo "{# Generated by dev #}"
	echo "{% load static %}"
	while true; do
		set +e
		res=$(curl "http://localhost:3000/" 2>/dev/null)
		code=$?
		set -e
		if [[ $code -eq 0 ]]; then
			break
		fi
		sleep 0.2
		echo "Waiting for dev server..." >&2
	done
	grep -E '<(script|link)' <<< "$res" | sed -E 's@src="(/[^"]+)@src="http://localhost:3000\1@'
} > templates/svelte_include_generated.html

wait
